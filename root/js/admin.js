var productEditor;var control=["home","products","product"];window.onload=function(){$("#menu-control").click(function(){$("#nav-list li").toggleClass("min");$(".container").toggleClass("max");$("nav").toggleClass("min-nav");$(this).blur()});productEditor=initEditor('content');renderPagination(false,"#products-pagination");$(".list a").click(function(){$(this).parent().parent().find('.list').removeClass('menu-focus');$(this).parent().addClass('menu-focus');var current=$(this).data("target");for(var i=0;i<control.length;i++){if(control[i]!==current){$("#"+control[i]).addClass("hidden")}else if($("#"+current).hasClass("hidden")){$("#"+current).removeClass("hidden");if(current=="products"){renderPagination(false,"#products-pagination")}}}$(this).blur()})}function updateArticleNum(paginationId,callback){$pagination=$(paginationId);$.ajax({type:"GET",dataType:"html",url:$pagination.data('num-url'),data:'',success:function(data){if(data!="-1"){tmpNum=parseInt(data);pages=parseInt(tmpNum/$pagination.data('single-num'))+(tmpNum%10>0?1:0);currentPage=$pagination.data('current-page');while(currentPage>pages-1&&currentPage>0){currentPage--}$(paginationId).data('pages',pages);$(paginationId).data('current-page',currentPage);callback(true,paginationId)}else{addDangerInfo("获取数量失败~")}},error:function(data){addDangerInfo("获取数量失败~")}})}function updatePaginationState(id){$pagination=$(id);currentPage=$pagination.data('current-page');pages=$pagination.data('pages');if(currentPage==0){$pagination.find(":first").addClass("disabled")}else{$pagination.find(":first").removeClass("disabled")}if(currentPage==pages-1){$pagination.children(":last").addClass("disabled")}else{$pagination.children(":last").removeClass("disabled")}}function renderPagination(flag=false,paginationId=null){if(!flag){updateArticleNum(paginationId,renderPagination);return}$pagination=$(paginationId);$pagination.children().remove();renderList(paginationId);if(pages==0){return}$pagination.append($('<li><a href="javascript:void(0)" data-page=0 onclick="changePage(this)">&laquo</a></li>'));for(var i=1;i<=pages;i++){$dom=$('<li><a href="javascript:void(0)" data-page='+(i-1)+' onclick="changePage(this)">'+i+'</a></li>');$pagination.append($dom);if(i==$pagination.data('current-page')+1){$dom.addClass("active")}}$pagination.append($('<li><a href="javascript:void(0)" data-page='+($pagination.data('pages')-1)+' onclick="changePage(this)">&raquo</a></li>'));updatePaginationState(paginationId)}function changePage(e){$li=$(e).parent();if($li.hasClass("active")||$li.hasClass("disabled")){return}currentPage=$(e).data("page");$pagination=$li.parent();$pagination.find(".active").removeClass("active");$pagination.find("a[data-page='"+currentPage+"']").parent().addClass("active");renderList($pagination.attr('id'));updatePaginationState($pagination.attr('id'))}function initEditor(id){wangEditor.config.printLog=false;editor=new wangEditor(id);editor.config.uploadImgUrl="/index.php/upload";editor.config.uploadImgFileName='uploadImgFile';editor.config.emotions={'default':{title:'默认',data:'../emotions.data'},};editor.config.menus=['source','|','bold','underline','italic','strikethrough','eraser','forecolor','bgcolor','|','quote','fontfamily','fontsize','head','unorderlist','orderlist','alignleft','aligncenter','alignright','|','link','unlink','table','emotion','|','img','video','location','insertcode','|','undo','redo','fullscreen'];editor.create();return editor}function save(e){$button=$(e);$button.button('loading');$.ajax({type:"POST",dataType:"html",url:'/index.php/product/addProduct',data:$('#product-data').serialize(),success:function(data){$button.button('reset');if(data<0){addDangerInfo("error:"+data);return}$("#pid").val(data);$dom=addSuccessInfo("Save product successfully~~");$dom.delay(1000).hide(1000,function(){$(this).remove()})},error:function(data){$button.button('reset');addDangerInfo("error:"+data.responseText)}})}function addSuccessInfo(info){$tmp=$('<div class="alert alert-success alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>'+info+'</div>');$("#hints").prepend($tmp);return $tmp}function addInfoInfo(info){$tmp=$('<div class="alert alert-info alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>'+info+'</div>');$("#hints").prepend($tmp);return $tmp}function addWarningInfo(info){$tmp=$('<div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>'+info+'</div>');$("#hints").prepend($tmp);return $tmp}function addDangerInfo(info){$tmp=$('<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>'+info+'</div>');$("#hints").prepend($tmp);return $tmp}function renderList(paginationId){$pagination=$(paginationId);$.ajax({type:"GET",dataType:"html",url:$pagination.data('list-url'),data:"page="+$pagination.data('current-page'),success:function(data){if(data==-1){addDangerInfo(data.responseText)}data=$.parseJSON(data);$tbody=$($pagination.data('table')).find("tbody");$tbody.find("tr").remove();for(var i=0;i<data.length;i++){$dom=eval($pagination.data('render'));$tbody.append($dom)}},error:function(data){addDangerInfo(data.responseText)}})}function renderProduct(data){return $('<tr><td><a href="#" data-pid='+data.id+' onclick="editProduct(this)">'+data.name+'</a></td><td width="100"><span>'+data.instock+'</span></td></tr>')}function editProduct(e){pid=$(e).data('pid');publishProduct();$("#func-name").html("Edit Product");$dom=addInfoInfo("正在获取商品信息");$.ajax({type:"GET",dataType:"html",url:'/index.php/product/getProductById',data:"pid="+pid,success:function(data){$dom.hide(1000,function(){$dom.remove()});data=$.parseJSON(data);$("#pid").val(data.id);$("#name").val(data.name);$("#img").val(data.img);$("#price").val(data.price);$("#stock").val(data.instock);productEditor.$txt.html(data.description)},error:function(data){$dom.hide(1000,function(){$dom.remove()});addDangerInfo(data.responseText)}})}function publishProduct(){$("#products").addClass("hidden");$("#product").removeClass("hidden");$("#func-name").html("Publish product");$("#pid").val("");$("#name").val("");$("#img").val("");$("#price").val("");$("#stock").val("");productEditor.$txt.html("")}function markAll(e){$tbody=$(e).parent().parent().parent().parent().find("tbody");if($(e).is(":checked")){$tbody.find("input:checkbox").not(":checked").prop("checked",true)}else{$tbody.find("input:checkbox:checked").prop("checked",false)}}